context.modules = [
    { name = libpipewire-module-filter-chain
        args = {
            node.description = "Surround Upmix with Gain Control"
            node.name        = "surround-gain-sink"
            media.class      = "Audio/Sink"
            audio.position   = [ FL FR ] # Final output is Stereo (2ch)
            filter.graph     = {
                nodes = [
                    # Node 1: Stereo Input -> 5.1 Upmix
                    {
                        node.name  = "upmix"
                        type       = "builtin"
                        plugin     = "remix"
                        label      = "upmix-5.1"
                        capture.props  = { audio.channels = 2 audio.position = [ FL FR ] }
                        playback.props = { audio.channels = 6 audio.position = [ FL FR FC LFE BL BR ] }
                    }

                    # Node 2: Runtime Gain Control for the Surround Effect (6 channels)
                    # This node will be targeted by the TypeScript class.
                    {
                        node.name  = "effect-gain"
                        type       = "builtin"
                        plugin     = "gain"
                        # The 'gain' builtin filter uses Control Index 0 for its gain value
                        control    = { "0" = 1.0 } # Start at full gain (ON)
                        capture.props  = { audio.channels = 6 }
                        playback.props = { audio.channels = 6 }
                    }

                    # Node 3: 5.1 Surround -> Stereo Downmix
                    {
                        node.name  = "downmix"
                        type       = "builtin"
                        plugin     = "remix"
                        label      = "downmix-stereo"
                        capture.props  = { audio.channels = 6 audio.position = [ FL FR FC LFE BL BR ] }
                        playback.props = { audio.channels = 2 audio.position = [ FL FR ] }
                    }
                ]

                # Links define the signal flow: UPMIX -> GAIN -> DOWNMIX
                links = [
                    { output = "upmix:FL" input = "effect-gain:FL" }
                    # ... link all 6 channels ...
                    { output = "upmix:FR" input = "effect-gain:FR" }
                    { output = "upmix:FC" input = "effect-gain:FC" }
                    { output = "upmix:LFE" input = "effect-gain:LFE" }
                    { output = "upmix:BL" input = "effect-gain:BL" }
                    { output = "upmix:BR" input = "effect-gain:BR" }

                    { output = "effect-gain:FL" input = "downmix:FL" }
                    # ... link all 6 channels ...
                    { output = "effect-gain:FR" input = "downmix:FR" }
                    { output = "effect-gain:FC" input = "downmix:FC" }
                    { output = "effect-gain:LFE" input = "downmix:LFE" }
                    { output = "effect-gain:BL" input = "downmix:BL" }
                    { output = "effect-gain:BR" input = "downmix:BR" }
                ]
            }
        }
    }
]

